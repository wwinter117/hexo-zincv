---
title: redis持久化总结
tags:
  - redis
date: 2022-6-12 22:46:49
---
![](https://zincv.oss-cn-hangzhou.aliyuncs.com/images/redis-5fb76d3ec9fd434fe46a579d9c1c8a83.jpeg)

`Redis` 是一个高性能的内存数据库，但为了防止数据丢失，Redis 提供了持久化机制，将数据存储到磁盘中。在 `Redis` 中，有两种主要的持久化方式：`RDB`（Redis Database）快照和 `AOF`（Append-Only File）日志。接下来介绍这两种持久化方式。

## 一、RDB 持久化

### 1.1 什么是 RDB 持久化

`RDB`（Redis Database）持久化是指 `Redis` 以二进制文件的形式将内存中的数据快照保存到磁盘中。生成的文件通常称为 `RDB` 文件（默认名为 `dump.rdb`）。当 `Redis` 服务器重启时，可以通过加载这个 RDB 文件来恢复数据。

### 1.2 RDB 的工作原理

`RDB` 的工作原理是在指定的时间间隔内保存内存中的数据到 `RDB` 文件中，也叫做“快照”。`RDB` 快照可以通过两种方式触发：

- **自动快照**：通过配置 `save` 选项，`Redis` 可以在指定的条件下自动生成 `RDB` 快照，例如在一定时间内执行了多少次写操作。

- **手动快照**：可以通过命令 `SAVE` 或 `BGSAVE` 手动生成 `RDB` 快照。`SAVE` 会阻塞 `Redis` 服务器，直到快照完成，而 `BGSAVE` 则是通过创建子进程在后台完成快照操作，主进程可以继续处理客户端请求。

### 1.3 RDB 的优缺点
#### 优点：

- **磁盘空间使用少**：`RDB` 文件是高度压缩的二进制文件，占用的磁盘空间较小。
- **恢复速度快**：因为 `RDB` 文件是紧凑的二进制格式，加载速度较快，适合快速恢复大规模数据。
- **适合备份**：`RDB` 文件包含了某个时间点的完整数据快照，适合定期备份和归档。

#### 缺点：

- **数据丢失风险**：`RDB` 持久化是定期的，因此在上次快照和服务器崩溃之间的写操作会丢失。
- **生成快照时性能影响较大**：在生成快照时需要将内存数据写入磁盘，对于大数据集，可能会对 `Redis` 性能造成一定影响。

### 1.4 RDB 的配置示例

```bash
# 每 900 秒（15 分钟）内至少有 1 次写操作时，生成 RDB 快照
save 900 1
# 每 300 秒（5 分钟）内至少有 10 次写操作时，生成 RDB 快照
save 300 10
# 每 60 秒内至少有 10000 次写操作时，生成 RDB 快照
save 60 10000
```

## 二、AOF 持久化
### 2.1 什么是 AOF 持久化

`AOF`（Append-Only File）持久化是 `Redis` 通过记录每次写操作的日志来实现数据持久化的机制。`AOF` 文件以追加的方式将每次写操作记录下来，当 `Redis` 重启时，通过重新执行这些操作日志来恢复数据。

### 2.2 AOF 的工作原理

`AOF` 通过记录每个写操作的命令，将其追加到 `AOF` 文件中。当服务器重启时，`Redis` 会从 `AOF` 文件中逐条读取命令并重新执行，以此恢复数据。

`AOF` 的记录策略由 `appendfsync` 选项控制：

- **always**：每次写操作都立即同步到 `AOF` 文件中，最安全但性能最差。
- **everysec**：每秒同步一次，性能和安全性折中方案（默认）。
- **no**：完全依赖操作系统，性能最好，但在服务器崩溃时可能会丢失多秒的数据。

### 2.3 AOF 的优缺点
#### 优点：

- **数据丢失风险小**：`AOF` 记录每次写操作，数据持久化频率高，丢失的数据量很少。
- **AOF 文件可读性强**：`AOF` 文件是以 `Redis` 命令的形式记录的，可以直接查看和理解日志内容。
- **支持重写**：`Redis` 支持 `AOF` 文件的重写机制，以减少文件大小，并移除冗余命令。

#### 缺点：

- **AOF 文件较大**：`AOF` 文件比 `RDB` 文件大很多，因为它记录了每次写操作，而不是整个数据集的快照。
- **恢复速度较慢**：因为需要逐条执行写操作，恢复速度比 `RDB` 慢。
- **潜在的性能开销**：频繁的磁盘写操作可能会对性能产生影响，尤其是在 `appendfsync` 设置为 `always` 时。

### 2.4 AOF 的配置示例

```bash
# AOF 记录写操作的策略，默认每秒同步一次
appendonly yes
appendfsync everysec

# AOF 文件重写配置
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

## 三、混合持久化

从 `Redis` 4.0 开始，支持一种称为“混合持久化”的模式，结合了 `RDB` 和 `AOF` 的优点。在这种模式下，`Redis` 会在后台生成 `RDB` 快照并将其附加到 `AOF` 文件中，同时将最近的写操作追加到 `AOF` 文件中。这样可以在恢复时使用 `RDB` 的快速加载，同时保留 `AOF` 的高数据完整性。

### 混合持久化的配置示例

```bash
# 开启混合持久化
aof-use-rdb-preamble yes
```

## 四、选择合适的持久化策略

- **RDB 模式适合**：数据量大且对恢复速度要求高的场景，或者需要定期备份的情况。
- **AOF 模式适合**：对数据安全性要求较高的场景，需要尽可能减少数据丢失的风险。
- **混合持久化模式适合**：既需要快速恢复，又希望最大程度减少数据丢失的场景。

